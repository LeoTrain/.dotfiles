#!/bin/bash

repos=( "$HOME/.dotfiles" )
for dir in "$HOME/lab"/*/; do
	[ -d "$dir" ] && repos+=( "$dir" )
done

NOTIFY="$HOME/.dotfiles/scripts/utils/send_notification"

all_clean=true

for repo in "${repos[@]}"; do
  repo_name=$(basename "$repo")

  if [ ! -d "$repo/.git" ]; then
    $SECHO "${RED}$repo_name: ❌ Not a git repository.${RESET}"
    all_clean=false
    continue
  fi

  cd "$repo" || continue
  git fetch &> /dev/null

  status_line=$(git status -sb 2>/dev/null | head -n 1)
  uncommitted=$(git status --porcelain)

  if [ -n "$uncommitted" ]; then
    $NOTIFY "$repo_name" "✏️ You have uncommitted changes." -u normal
	  all_clean=false
	elif [[ "$status_line" == *"[ahead "* ]]; then
	  $NOTIFY "$repo_name" "🔼 You have commits to push." -u critical 
	  all_clean=false
	elif [[ "$status_line" == *"[behind "* ]]; then
	  $NOTIFY "$repo_name" "🔽 There are commits to pull." -u critical
	  all_clean=false
	elif [[ "$status_line" == *"[diverged"* ]]; then
	  $NOTIFY "$repo_name" "⚠️ Branch has diverged." -u critical
	  all_clean=false
  fi
done

if $all_clean; then
  $NOTIFY "Git Push Check" "✅ All repositories are up-to-date." -u normal
fi

